!function(factory){"object"==typeof module&&"object"==typeof module.exports?factory(require("jquery"),window,document):factory(jQuery,window,document)}(function($,window,document,undefined){var wxmodals=[],getCurrent=function(){return wxmodals.length?wxmodals[wxmodals.length-1]:null},selectCurrent=function(){var i,selected=!1;for(i=wxmodals.length-1;i>=0;i--)wxmodals[i].$blocker&&(wxmodals[i].$blocker.toggleClass("current",!selected).toggleClass("behind",selected),selected=!0)};$.wxmodal=function(el,options){var remove,target;if(this.$body=$("body"),this.options=$.extend({},$.wxmodal.defaults,options),this.options.doFade=!isNaN(parseInt(this.options.fadeDuration,10)),this.$blocker=null,this.options.closeExisting)for(;$.wxmodal.isActive();)$.wxmodal.close();if(wxmodals.push(this),el.is("a"))if(target=el.attr("href"),/^#/.test(target)){if(this.$elm=$(target),1!==this.$elm.length)return null;this.$body.append(this.$elm),this.open()}else this.$elm=$("<div>"),this.$body.append(this.$elm),remove=function(event,modal){modal.elm.remove()},this.showSpinner(),el.trigger($.wxmodal.AJAX_SEND),$.get(target).done(function(html){if($.wxmodal.isActive()){el.trigger($.wxmodal.AJAX_SUCCESS);var current=getCurrent();current.$elm.empty().append(html).on($.wxmodal.CLOSE,remove),current.hideSpinner(),current.open(),el.trigger($.wxmodal.AJAX_COMPLETE)}}).fail(function(){var current;el.trigger($.wxmodal.AJAX_FAIL),getCurrent().hideSpinner(),wxmodals.pop(),el.trigger($.wxmodal.AJAX_COMPLETE)});else this.$elm=el,this.$body.append(this.$elm),this.open()},$.wxmodal.prototype={constructor:$.wxmodal,open:function(){var m=this;this.block(),this.options.doFade?setTimeout(function(){m.show()},this.options.fadeDuration*this.options.fadeDelay):this.show(),$(document).off("keydown.wxmodal").on("keydown.wxmodal",function(event){var current=getCurrent();27==event.which&&current.options.escapeClose&&current.close()}),this.options.clickClose&&this.$blocker.click(function(e){e.target==this&&$.wxmodal.close()})},close:function(){wxmodals.pop(),this.unblock(),this.hide(),$.wxmodal.isActive()||$(document).off("keydown.wxmodal")},block:function(){this.$elm.trigger($.wxmodal.BEFORE_BLOCK,[this._ctx()]),this.$body.css("overflow","hidden"),this.$blocker=$('<div class="jquery-modal blocker current"></div>').appendTo(this.$body),selectCurrent(),this.options.doFade&&this.$blocker.css("opacity",0).animate({opacity:1},this.options.fadeDuration),this.$elm.trigger($.wxmodal.BLOCK,[this._ctx()])},unblock:function(now){!now&&this.options.doFade?this.$blocker.fadeOut(this.options.fadeDuration,this.unblock.bind(this,!0)):(this.$blocker.children().appendTo(this.$body),this.$blocker.remove(),this.$blocker=null,selectCurrent(),$.wxmodal.isActive()||this.$body.css("overflow",""))},show:function(){this.$elm.trigger($.wxmodal.BEFORE_OPEN,[this._ctx()]),this.options.showClose&&(this.closeButton=$('<a href="#close-wxmodal" rel="wxmodal:close" class="close-wxmodal '+this.options.closeClass+'">'+this.options.closeText+"</a>"),this.$elm.append(this.closeButton)),this.$elm.addClass(this.options.modalClass).appendTo(this.$blocker),this.options.doFade?this.$elm.css("opacity",0).show().animate({opacity:1},this.options.fadeDuration):this.$elm.show(),this.$elm.trigger($.wxmodal.OPEN,[this._ctx()])},hide:function(){this.$elm.trigger($.wxmodal.BEFORE_CLOSE,[this._ctx()]),this.closeButton&&this.closeButton.remove();var _this=this;this.options.doFade?this.$elm.fadeOut(this.options.fadeDuration,function(){_this.$elm.trigger($.wxmodal.AFTER_CLOSE,[_this._ctx()])}):this.$elm.hide(0,function(){_this.$elm.trigger($.wxmodal.AFTER_CLOSE,[_this._ctx()])}),this.$elm.trigger($.wxmodal.CLOSE,[this._ctx()])},showSpinner:function(){this.options.showSpinner&&(this.spinner=this.spinner||$('<div class="'+this.options.wxmodalClass+'-spinner"></div>').append(this.options.spinnerHtml),this.$body.append(this.spinner),this.spinner.show())},hideSpinner:function(){this.spinner&&this.spinner.remove()},_ctx:function(){return{elm:this.$elm,$blocker:this.$blocker,options:this.options}}},$.wxmodal.close=function(event){if($.wxmodal.isActive()){event&&event.preventDefault();var current=getCurrent();return current.close(),current.$elm}},$.wxmodal.isActive=function(){return wxmodals.length>0},$.wxmodal.getCurrent=getCurrent,$.wxmodal.defaults={closeExisting:!0,escapeClose:!0,clickClose:!0,closeText:"Close",closeClass:"",modalClass:"wxmodal",spinnerHtml:null,showSpinner:!0,showClose:!0,fadeDuration:null,fadeDelay:1},$.wxmodal.BEFORE_BLOCK="wxmodal:before-block",$.wxmodal.BLOCK="wxmodal:block",$.wxmodal.BEFORE_OPEN="wxmodal:before-open",$.wxmodal.OPEN="wxmodal:open",$.wxmodal.BEFORE_CLOSE="wxmodal:before-close",$.wxmodal.CLOSE="wxmodal:close",$.wxmodal.AFTER_CLOSE="wxmodal:after-close",$.wxmodal.AJAX_SEND="wxmodal:ajax:send",$.wxmodal.AJAX_SUCCESS="wxmodal:ajax:success",$.wxmodal.AJAX_FAIL="wxmodal:ajax:fail",$.wxmodal.AJAX_COMPLETE="wxmodal:ajax:complete",$.fn.wxmodal=function(options){return 1===this.length&&new $.wxmodal(this,options),this},$(document).on("click.wxmodal",'a[rel="wxmodal:close"]',$.wxmodal.close),$(document).on("click.wxmodal",'a[rel="wxmodal:open"]',function(event){event.preventDefault(),$(this).wxmodal()})});